# 智能分析功能使用指南

## 📖 功能概述

智能分析功能是基于底层小模型 Agent 的智能判定系统，能够在语音讨论场景下自动分析对话内容，智能判定是否需要启动多模型共话来辅助主人公获取更有利的回答。

## 🚀 快速开始

### 1. 配置 API 密钥

编辑 `api_config.json` 文件：

```json
{
    "configs": [
        {
            "name": "DeepSeek-V3",
            "base_url": "https://api.deepseek.com/v1",
            "api_key": "YOUR_DEEPSEEK_API_KEY",
            "model": "deepseek-chat"
        },
        {
            "name": "SmartAgent",
            "base_url": "https://api.provider.com/v1",
            "api_key": "YOUR_AGENT_API_KEY",
            "model": "qwen-turbo"
        }
    ],
    "agent_config": {
        "enabled": true,
        "model_name": "SmartAgent",
        "min_characters": 10,
        "silence_threshold": 2
    }
}
```

### 2. 启动服务器

```bash
python server.py
```

### 3. 访问界面

打开浏览器访问: http://localhost:8000

### 4. 启用智能分析

在 AI 助手面板中，点击"智能分析"按钮开启功能。

## ⚙️ 配置说明

### 智能分析配置参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `enabled` | 是否启用智能分析 | false |
| `model_name` | 小模型配置名称 | - |
| `min_characters` | 字数阈值（触发判定） | 10 |
| `silence_threshold` | 静音检测秒数 | 2 |
| `auto_trigger` | 是否自动触发 | true |

### 触发条件

1. **字数累积**: 实时语音转写积累 10 个字时激活判定
2. **静音检测**: 检测到 2 秒没有新声音输入时触发
3. **说话人识别**: 自动识别主人公身份

## 🎯 使用场景

### ✅ 会触发智能分析的场景

- **技术讨论**: "这个 Python 异步编程有什么最佳实践？"
- **决策咨询**: "我该选择 React 还是 Vue 做这个项目？"
- **问题解决**: "数据库查询很慢，该怎么优化？"
- **学习讨论**: "能解释一下微服务架构的优势吗？"

### ❌ 不会触发智能分析的场景

- **日常对话**: "你好吗？" / "今天天气不错"
- **个人问题**: "你家是哪里的？" / "你叫什么名字？"
- **无关内容**: "这个西瓜很甜" / "我喜欢这首歌"

## 🔧 API 接口

### 获取智能分析状态

```bash
GET /api/agent/status
```

响应示例：
```json
{
    "available": true,
    "enabled": true,
    "auto_trigger": true,
    "status": {
        "accumulated_chars": 15,
        "threshold": 10,
        "last_speaker": "张三"
    }
}
```

### 启用/禁用智能分析

```bash
POST /api/agent/enable
Content-Type: application/json

{
    "enabled": true,
    "auto_trigger": true
}
```

### 手动触发智能分析

```bash
POST /api/agent/analyze
Content-Type: application/json

{
    "messages": [
        {
            "role": "user",
            "content": "这个Python异步编程有什么最佳实践？",
            "speaker": "张三"
        }
    ],
    "speaker_name": "张三"
}
```

## 🎨 前端界面

### 智能分析开关

位于 AI 助手面板右上角，图标为智能大脑形状。

- **关闭状态**: 显示"智能分析"
- **开启状态**: 显示"智能分析 ON"并高亮

### 智能分析通知

当智能分析被触发时，界面会显示：

```
🤖 智能分析已启动，将同时调用 2 个模型为您提供建议
```

## 🏗️ 系统架构

```
┌─────────────────────────────────────────┐
│           ASR 转写结果                    │
│     (包含说话人和文本内容)                 │
└───────────────┬─────────────────────────┘
                ▼
┌─────────────────────────────────────────┐
│         字数累积检测器                    │
│      (检查是否 ≥ 10 个字)                 │
└───────────────┬─────────────────────────┘
                ▼
┌─────────────────────────────────────────┐
│         静音检测器                        │
│    (2秒 无新语音输入触发)                  │
└───────────────┬─────────────────────────┘
                ▼
┌─────────────────────────────────────────┐
│      小模型 Agent 判定                    │
│     (分析上下文和意图)                    │
└───────────────┬─────────────────────────┘
                ▼
┌─────────────────────────────────────────┐
│         JSON 结果解析                     │
│       {is: true/false}                   │
└───────────────┬─────────────────────────┘
                │
                ▼
    ┌───────────┴───────────┐
    ▼                       ▼
┌─────────┐           ┌──────────────┐
│ is=true │           │  is=false   │
└─────────┘           └──────────────┘
    ▼
┌──────────────────────────────┐
│    启动多模型共话              │
│  (调用所有激活的 LLM)          │
└──────────────────────────────┘
```

## 🧪 测试

运行测试脚本：

```bash
python test_intelligent_agent.py
```

测试内容：
1. 小模型 Agent 判定逻辑
2. 触发机制（字数阈值 + 静音检测）
3. 配置文件加载
4. API 端点可用性

## ❓ 常见问题

### Q: 智能分析不触发？

**A**: 检查以下几点：
1. 确认已启用智能分析（开关为 ON 状态）
2. 确认字数达到阈值（默认 10 字）
3. 确认有静音间隔（默认 2 秒）
4. 检查 API 密钥是否有效

### Q: 多模型共话未激活？

**A**: 检查以下几点：
1. 在设置中勾选要参与的模型
2. 确认小模型判定结果为 `is: true`
3. 查看控制台日志了解详细原因

### Q: 如何调整触发阈值？

**A**: 在 `api_config.json` 中修改：
```json
"agent_config": {
    "min_characters": 15,      // 调整为 15 字
    "silence_threshold": 3     // 调整为 3 秒
}
```

### Q: 可以使用本地模型吗？

**A**: 目前智能分析功能主要支持云端 API。本地模型功能正在开发中，敬请期待。

## 📝 开发说明

### 核心模块

- `intelligent_agent.py`: 智能分析 Agent 核心逻辑
- `trigger_manager.py`: 触发机制管理器
- `server.py`: Web 服务器和 API 端点
- `static/script.js`: 前端智能分析逻辑

### 扩展开发

如需自定义判定逻辑，修改 `intelligent_agent.py` 中的 `build_analysis_prompt` 方法。

## 📄 许可证

本项目基于 MIT 许可证开源。

## 🙏 致谢

感谢所有为智能分析功能开发做出贡献的开发者！
