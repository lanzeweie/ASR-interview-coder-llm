# AST å®æ—¶è¯­éŸ³è½¬æ–‡æœ¬ä¸å¤§æ¨¡å‹åˆ†æç³»ç»Ÿ

> é¡¹ç›®åˆå§‹åŒ–æ—¶é—´: 2025-11-25

## ğŸ“– é¡¹ç›®æ¦‚è§ˆ

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº Python çš„å®æ—¶è¯­éŸ³è½¬æ–‡æœ¬ï¼ˆASRï¼‰ä¸å¤§æ¨¡å‹åˆ†æç³»ç»Ÿï¼Œé›†æˆäº†è¯­éŸ³è¯†åˆ«ã€è¯´è¯äººè¯†åˆ«ï¼ˆå£°çº¹ï¼‰ã€è¯­éŸ³æ´»åŠ¨æ£€æµ‹ï¼ˆVADï¼‰ç­‰æŠ€æœ¯ï¼Œå¹¶æä¾› Web ç•Œé¢æ”¯æŒå®æ—¶äº¤äº’ã€‚

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

- **å®æ—¶è¯­éŸ³è½¬æ–‡æœ¬ï¼ˆASRï¼‰**: åŸºäº SenseVoice Small æ¨¡å‹ï¼Œæ”¯æŒå¤šè¯­è¨€è¯†åˆ«
- **è¯´è¯äººè¯†åˆ«**: åŸºäº CAM++ æ¨¡å‹ï¼Œæ”¯æŒå£°çº¹åº“ç®¡ç†å’Œå®æ—¶è¯´è¯äººè¯†åˆ«
- **è¯­éŸ³æ´»åŠ¨æ£€æµ‹ï¼ˆVADï¼‰**: åŸºäº WebRTC VADï¼Œå‡†ç¡®æ£€æµ‹è¯­éŸ³ç‰‡æ®µ
- **å¤§æ¨¡å‹å¯¹è¯**: é›†æˆå¤šç§ LLM APIï¼ˆOpenAI å…¼å®¹ï¼‰ï¼Œæ”¯æŒæµå¼å¯¹è¯
- **Web ç•Œé¢**: å“åº”å¼ç•Œé¢ï¼Œæ”¯æŒå®æ—¶æ˜¾ç¤ºè½¬å½•ç»“æœå’Œ LLM å¯¹è¯
- **å¤šä¼šè¯ç®¡ç†**: æ”¯æŒèŠå¤©å†å²ã€ä¼šè¯åˆ‡æ¢ç­‰åŠŸèƒ½

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ¶æ„æ€»è§ˆ (Mermaid)

```mermaid
graph TB
    subgraph "éŸ³é¢‘é‡‡é›†å±‚"
        A[éº¦å…‹é£è¾“å…¥] --> B[PyAudio å½•éŸ³]
    end

    subgraph "è¯­éŸ³å¤„ç†å±‚"
        B --> C[VAD è¯­éŸ³æ£€æµ‹]
        C --> D[éŸ³é¢‘åˆ†æ®µ]
        D --> E[ASR è¯­éŸ³è½¬æ–‡æœ¬]
        D --> F[SV å£°çº¹è¯†åˆ«]
    end

    subgraph "æ¨¡å‹æœåŠ¡å±‚"
        E --> G[SenseVoice Small<br/>è¯­éŸ³è¯†åˆ«]
        F --> H[CAM++ å£°çº¹æ¨¡å‹]
    end

    subgraph "åç«¯æœåŠ¡å±‚"
        I[FastAPI æœåŠ¡å™¨]
        J[WebSocket è¿æ¥ç®¡ç†]
        K[ChatManager ä¼šè¯ç®¡ç†]
        L[LLMClient API å®¢æˆ·ç«¯]
    end

    subgraph "å¤–éƒ¨æœåŠ¡"
        M[OpenAI å…¼å®¹ API<br/>DeepSeek/å…¶ä»– LLM]
    end

    subgraph "å‰ç«¯å±•ç¤ºå±‚"
        N[HTML ç•Œé¢]
        O[JavaScript äº¤äº’]
        P[WebSocket å®æ—¶é€šä¿¡]
        Q[CSS æ ·å¼]
    end

    subgraph "æ•°æ®å­˜å‚¨"
        R[Voiceprints/ å£°çº¹åº“]
        S[Output/ éŸ³é¢‘è¾“å‡º]
        T[Chat History èŠå¤©è®°å½•]
        U[API Config é…ç½®]
    end

    %% æ•°æ®æµ
    G --> I
    H --> I
    I --> J
    I --> K
    I --> L
    L --> M
    I --> N
    N --> P
    P --> J
    O --> L

    %% å­˜å‚¨è¿æ¥
    I --> R
    I --> S
    K --> T
    L --> U
```

### æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯/æ¡†æ¶ | ç‰ˆæœ¬/è¯´æ˜ |
|------|-----------|-----------|
| **ASR æ¨¡å‹** | SenseVoice Small | FunASR |
| **å£°çº¹è¯†åˆ«** | CAM++ | ModelScope |
| **VAD** | WebRTC VAD | webrtcvad |
| **éŸ³é¢‘å¤„ç†** | librosa, soundfile, numpy | éŸ³é¢‘åŠ è½½/å¤„ç† |
| **å½•éŸ³** | PyAudio | å®æ—¶éŸ³é¢‘é‡‡é›† |
| **Web æ¡†æ¶** | FastAPI | åç«¯ API æœåŠ¡ |
| **å‰ç«¯** | HTML + JavaScript + CSS | åŸç”Ÿå®ç° |
| **LLM å®¢æˆ·ç«¯** | OpenAI Python SDK | å…¼å®¹å¤šå‚å•† API |
| **é…ç½®ç®¡ç†** | JSON | è½»é‡çº§é…ç½®å­˜å‚¨ |

## ğŸ“‚ æ¨¡å—ç´¢å¼•

### æ ¸å¿ƒæ¨¡å—

| æ¨¡å—è·¯å¾„ | ç±»å‹ | æè¿° | å…³é”®åŠŸèƒ½ |
|----------|------|------|----------|
| **[main.py]** | æ¨¡å—å…¥å£ | ASR å®æ—¶å¤„ç†æ ¸å¿ƒ | è¯­éŸ³è½¬æ–‡æœ¬ã€å£°çº¹è¯†åˆ«ã€VAD æ£€æµ‹ |
| **[server.py]** | Web æœåŠ¡ | FastAPI æœåŠ¡å™¨ | WebSocketã€REST APIã€çº¿ç¨‹ç®¡ç† |
| **[llm_client.py]** | å®¢æˆ·ç«¯ | LLM API é›†æˆ | å¤šå‚å•† APIã€æµå¼å“åº” |
| **[chat_manager.py]** | ç®¡ç†å™¨ | èŠå¤©ä¼šè¯ç®¡ç† | å¤šä¼šè¯ã€å†å²å­˜å‚¨ |
| **[test_chat_api.py]** | æµ‹è¯• | API æµ‹è¯•è„šæœ¬ | ç«¯ç‚¹åŠŸèƒ½éªŒè¯ |

### å‰ç«¯èµ„æº

| è·¯å¾„ | ç±»å‹ | æè¿° |
|------|------|------|
| **[static/]** | ç›®å½• | å‰ç«¯é™æ€èµ„æº |
| **[static/index.html]** | UI é¡µé¢ | ä¸»ç•Œé¢å¸ƒå±€ |
| **[static/script.js]** | è„šæœ¬ | å‰ç«¯äº¤äº’é€»è¾‘ |
| **[static/style.css]** | æ ·å¼ | UI æ ·å¼å®šä¹‰ |

### é…ç½®ä¸æ•°æ®

| æ–‡ä»¶ | ç±»å‹ | æè¿° |
|------|------|------|
| **[api_config.json]** | é…ç½® | LLM API é…ç½®ä¿¡æ¯ |
| **[voiceprints/]** | ç›®å½• | å£°çº¹åº“ï¼ˆç”¨æˆ·éŸ³é¢‘æ ·æœ¬ï¼‰ |
| **[output/]** | ç›®å½• | ä¸´æ—¶éŸ³é¢‘æ–‡ä»¶è¾“å‡º |
| **[chat_history.json]** | æ•°æ® | èŠå¤©ä¼šè¯å†å²è®°å½• |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒä¾èµ–

```bash
# æ ¸å¿ƒä¾èµ–
pip install funasr modelscope webrtcvad pyaudio librosa soundfile numpy fastapi uvicorn websockets openai

# å¯é€‰ï¼šCUDA æ”¯æŒï¼ˆç”¨äº GPU åŠ é€Ÿï¼‰
# ç¡®ä¿å·²å®‰è£… CUDA å’Œ PyTorch
```

### æ¨¡å‹ä¸‹è½½

ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸‹è½½ä»¥ä¸‹æ¨¡å‹ï¼š
- **SenseVoiceSmall**: çº¦ 200MBï¼Œç”¨äºè¯­éŸ³è¯†åˆ«
- **CAM++ å£°çº¹æ¨¡å‹**: çº¦ 50MBï¼Œç”¨äºè¯´è¯äººè¯†åˆ«

> é¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ä» ModelScope/HuggingFace ä¸‹è½½

### é…ç½® LLM API

ç¼–è¾‘ `api_config.json`:

```json
{
    "configs": [
        {
            "name": "your-model-name",
            "base_url": "https://api.your-provider.com/v1",
            "api_key": "your-api-key",
            "model": "your-model"
        }
    ],
    "current_config": "your-model-name"
}
```

### è¿è¡Œæ–¹å¼

#### 1. å®Œæ•´ç³»ç»Ÿï¼ˆæ¨èï¼‰

```bash
python server.py
```

è®¿é—® http://localhost:8000 æŸ¥çœ‹ Web ç•Œé¢

#### 2. çº¯ ASR æ¨¡å¼

```bash
python main.py
```

æ§åˆ¶å°å®æ—¶æ˜¾ç¤ºè½¬å½•ç»“æœ

#### 3. æµ‹è¯• API

```bash
python test_chat_api.py
```

## âš™ï¸ æ ¸å¿ƒé…ç½®å‚æ•°

### ASR é…ç½® (main.py)

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `AUDIO_RATE` | 16000 | éŸ³é¢‘é‡‡æ ·ç‡ï¼ˆHzï¼‰ |
| `AUDIO_CHANNELS` | 1 | éŸ³é¢‘é€šé“æ•°ï¼ˆå•å£°é“ï¼‰ |
| `CHUNK` | 1024 | éŸ³é¢‘å—å¤§å° |
| `VAD_MODE` | 3 | VAD æ•æ„Ÿåº¦ï¼ˆ0-3ï¼‰ |
| `SV_THRESHOLD` | 0.35 | å£°çº¹è¯†åˆ«é˜ˆå€¼ |
| `OUTPUT_DIR` | "./output" | éŸ³é¢‘è¾“å‡ºç›®å½• |
| `VOICEPRINT_DIR` | "./voiceprints" | å£°çº¹åº“ç›®å½• |

### æœåŠ¡å™¨é…ç½® (server.py)

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `HOST` | "0.0.0.0" | æœåŠ¡ç›‘å¬åœ°å€ |
| `PORT` | 8000 | æœåŠ¡ç«¯å£ |
| `CONFIG_FILE` | "api_config.json" | é…ç½®æ–‡ä»¶è·¯å¾„ |

## ğŸ”Œ API æ¥å£

### WebSocket æ¥å£

#### `/ws` - ASR å®æ—¶æ•°æ®æ¨é€

```javascript
// æ¥æ”¶æ¶ˆæ¯æ ¼å¼
{
    "time": "14:30:25",
    "speaker": "å¼ ä¸‰ (ç½®ä¿¡åº¦:0.85)",
    "text": "ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯"
}
```

#### `/ws/llm` - LLM å¯¹è¯

```javascript
// å‘é€æ¶ˆæ¯
{
    "messages": [
        {"role": "user", "content": "ç”¨æˆ·è¾“å…¥"}
    ],
    "chat_id": "uuid"
}

// æ¥æ”¶æµå¼å“åº”
{
    "type": "chunk",
    "content": "AI å›å¤ç‰‡æ®µ"
}
```

### REST API

| æ¥å£ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/api/chats` | GET | è·å–èŠå¤©åˆ—è¡¨ |
| `/api/chats` | POST | åˆ›å»ºæ–°èŠå¤© |
| `/api/chats/{id}` | GET | è·å–èŠå¤©è¯¦æƒ… |
| `/api/chats/{id}` | DELETE | åˆ é™¤èŠå¤© |
| `/api/chats/{id}/clear` | POST | æ¸…ç©ºèŠå¤© |
| `/api/config` | GET | è·å– LLM é…ç½® |
| `/api/config` | POST | æ›´æ–° LLM é…ç½® |

## ğŸ”§ é«˜çº§åŠŸèƒ½

### å£°çº¹åº“ç®¡ç†

1. **æ·»åŠ è¯´è¯äºº**:
   - åœ¨ `voiceprints/` ç›®å½•æ”¾ç½® WAV æ–‡ä»¶
   - æ–‡ä»¶åå³ä¸ºè¯´è¯äººæ ‡è¯†ï¼ˆå¦‚ `å¼ ä¸‰.wav`ï¼‰
   - æ”¯æŒ 16kHz å•å£°é“ WAV æ ¼å¼

2. **è¯†åˆ«é€»è¾‘**:
   - è‡ªåŠ¨åŠ è½½æ‰€æœ‰ `.wav` æ–‡ä»¶
   - å®æ—¶æ¯”å¯¹éŸ³é¢‘ç‰‡æ®µ
   - ç½®ä¿¡åº¦è¶…è¿‡é˜ˆå€¼æ˜¾ç¤ºè¯´è¯äººä¿¡æ¯

### LLM å¯¹è¯åŠŸèƒ½

- **æµå¼å“åº”**: å®æ—¶æ˜¾ç¤º AI å›å¤
- **ä¸Šä¸‹æ–‡è®°å¿†**: è‡ªåŠ¨ä¿å­˜èŠå¤©å†å²
- **å¤šä¼šè¯**: æ”¯æŒå¤šä¸ªç‹¬ç«‹å¯¹è¯
- **å¤šæ¨¡å‹**: æ”¯æŒä»»æ„ OpenAI å…¼å®¹ API

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°æ¨¡å‹

1. **ASR æ¨¡å‹æ›¿æ¢** (main.py:36-40):

```python
self.model_asr = AutoModel(
    model="your-new-model",
    trust_remote_code=True,
    device="cuda"  # æˆ– "cpu"
)
```

2. **å£°çº¹æ¨¡å‹æ›¿æ¢** (main.py:44-48):

```python
self.sv_pipeline = pipeline(
    task='speaker-verification',
    model='your-sv-model-id',
    model_revision='v1.0.0'
)
```

### è‡ªå®šä¹‰å‰ç«¯ç•Œé¢

- ç¼–è¾‘ `static/index.html` ä¿®æ”¹é¡µé¢ç»“æ„
- ç¼–è¾‘ `static/style.css` è°ƒæ•´æ ·å¼
- ç¼–è¾‘ `static/script.js` æ·»åŠ äº¤äº’é€»è¾‘

### æ‰©å±• API åŠŸèƒ½

åœ¨ `server.py` ä¸­æ·»åŠ æ–°çš„ç«¯ç‚¹ï¼š

```python
@app.post("/api/new-endpoint")
async def new_feature(data: dict = Body(...)):
    # å¤„ç†é€»è¾‘
    return {"status": "success"}
```

## ğŸ› å¸¸è§é—®é¢˜

### Q: éŸ³é¢‘é‡‡æ ·ç‡ä¸åŒ¹é…é”™è¯¯

**A**: ç³»ç»Ÿä¼šè‡ªåŠ¨è½¬æ¢éŸ³é¢‘æ ¼å¼ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†ã€‚æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ˜¯å¦æŸåã€‚

### Q: LLM API è¿æ¥å¤±è´¥

**A**:
1. éªŒè¯ API Key æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ Base URL æ˜¯å¦åŒ…å« `/v1` åç¼€
3. ç¡®è®¤ç½‘ç»œå¯ä»¥è®¿é—® API æœåŠ¡

### Q: å£°çº¹è¯†åˆ«ä¸å‡†ç¡®

**A**:
1. å¢åŠ å£°çº¹åº“æ ·æœ¬æ•°é‡
2. è°ƒæ•´ `SV_THRESHOLD` å‚æ•°ï¼ˆé™ä½æé«˜æ•æ„Ÿåº¦ï¼‰
3. ç¡®ä¿å½•åˆ¶ç¯å¢ƒå®‰é™

### Q: å®æ—¶æ€§å»¶è¿Ÿè¿‡é«˜

**A**:
1. ä½¿ç”¨ GPU åŠ é€Ÿï¼ˆè®¾ç½® `device="cuda"`ï¼‰
2. é™ä½éŸ³é¢‘è´¨é‡ï¼ˆå‡å°‘ `CHUNK` å¤§å°ï¼‰
3. å…³é—­è¯¦ç»†æ—¥å¿—è¾“å‡º

## ğŸ“„ æ—¥å¿—ä¸è°ƒè¯•

### æ—¥å¿—è¾“å‡ºä½ç½®

- **æ§åˆ¶å°**: ä¸»è¦æ—¥å¿—ä¿¡æ¯
- **æµè§ˆå™¨æ§åˆ¶å°**: å‰ç«¯è°ƒè¯•ä¿¡æ¯
- **æœåŠ¡æ—¥å¿—**: FastAPI è¯·æ±‚æ—¥å¿—

### å…³é”®æ—¥å¿—å…³é”®è¯

- `[é…ç½®ä¿®æ­£]`: Base URL è‡ªåŠ¨ä¿®æ­£
- `[ç³»ç»Ÿ]`: LLM å®¢æˆ·ç«¯çŠ¶æ€
- `[è°ƒè¯•]`: è¯¦ç»†è°ƒè¯•ä¿¡æ¯
- `[é”™è¯¯]`: é”™è¯¯ä¿¡æ¯
- `[è­¦å‘Š]`: è­¦å‘Šä¿¡æ¯

## ğŸ“¦ æ•°æ®æ–‡ä»¶

### è¿è¡Œæ—¶ç”Ÿæˆ

| æ–‡ä»¶ | ä½ç½® | è¯´æ˜ |
|------|------|------|
| `chat_history.json` | æ ¹ç›®å½• | èŠå¤©ä¼šè¯æ•°æ® |
| `temp_speech.wav` | output/ | ä¸´æ—¶éŸ³é¢‘ç‰‡æ®µ |
| æ¨¡å‹ç¼“å­˜ | ~/.cache/ | FunASR/ModelScope æ¨¡å‹ |

### æŒä¹…åŒ–æ•°æ®

- **å£°çº¹åº“**: `voiceprints/` ç›®å½•ï¼ˆéœ€è¦å¤‡ä»½ï¼‰
- **èŠå¤©å†å²**: `chat_history.json`ï¼ˆå»ºè®®å¤‡ä»½ï¼‰
- **API é…ç½®**: `api_config.json`ï¼ˆå»ºè®®å¤‡ä»½ï¼‰

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **GPU åŠ é€Ÿ**: ç¡®ä¿ CUDA å¯ç”¨ï¼Œè®¾ç½® `device="cuda"`
2. **æ¨¡å‹é‡åŒ–**: è€ƒè™‘ä½¿ç”¨é‡åŒ–ç‰ˆæ¨¡å‹å‡å°å†…å­˜å ç”¨
3. **éŸ³é¢‘é¢„å¤„ç†**: é¢„åŠ è½½æ¨¡å‹åˆ°å†…å­˜
4. **å¹¶å‘å¤„ç†**: ä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†éŸ³é¢‘ç‰‡æ®µ
5. **ç¼“å­˜ç­–ç•¥**: ç¼“å­˜æ¨¡å‹æƒé‡å’Œé…ç½®

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork æœ¬é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. å‘èµ· Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº MIT è®¸å¯è¯å¼€æºã€‚

## ğŸ™ è‡´è°¢

- [FunASR](https://github.com/alibaba-damo-academy/FunASR) - ASR æ¡†æ¶
- [ModelScope](https://modelscope.cn/) - å¤šæ¨¡æ€æ¨¡å‹å¹³å°
- [WebRTC VAD](https://github.com/wangshub/webrtc-vad) - è¯­éŸ³æ´»åŠ¨æ£€æµ‹
- [FastAPI](https://fastapi.tiangolo.com/) - ç°ä»£ Python Web æ¡†æ¶

---

> ğŸ’¡ **æç¤º**: è¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒå„æ¨¡å—çš„ `CLAUDE.md` æ–‡ä»¶
